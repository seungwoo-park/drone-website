<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drone Map Mode</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        /* CSS는 이전과 동일하며, 레이아웃 문제를 해결한 최종 버전입니다. */
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f4ff; overflow: hidden; }
        body { display: flex; flex-direction: row; }
        #left-panel { width: 30%; min-width: 400px; height: 100vh; display: flex; flex-direction: column; background: #ffffff; border-right: 1px solid #ddd; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10;}
        .main-content-area { flex: 1; display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 1; background-color: #e5e5e5; }
        #bottom-panel { height: 33%; min-height: 250px; display: flex; background: #fafafa; border-top: 1px solid #ddd; overflow: hidden; }
        .panel-section { flex: 1; padding: 15px; box-sizing: border-box; border-right: 1px solid #eee; overflow-y: auto; }
        .panel-section:last-child { border-right: none; }
        .panel-section h3, .emergency-drone { font-size: 18px; font-weight: bold; color: #007bff; margin-top: 0; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .panel-section button { padding: 8px 12px; margin: 4px 2px; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; font-weight: 500; width: 100%; transition: background-color 0.2s; }
        .panel-section button:hover { background-color: #0056b3; }
        .panel-section strong { display: block; margin-top: 15px; }
        #video { border: 2px solid #007bff; border-radius: 8px; background-color: #000; width: 100%; height: auto; margin-top: 10px;}
        .reconnect-btn { background-color: #ffc107; color: black; }
        .status, #drone-power-status { margin-top: 10px; border-radius: 8px; padding: 8px; text-align: center; }
        .stats { margin-top: 10px; padding: 8px; background: #e9f5ff; border-radius: 6px; font-family: monospace; font-size: 12px; }
        #savedMissions { list-style: none; padding: 0; }
        #savedMissions li { background: #e7f1ff; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px; }
        #savedMissions li button { width: auto; font-size: 12px; padding: 4px 8px; }
        .styled-select { display: block; width: 100%; padding: 10px; border: 1px solid #007bff; border-radius: 8px; margin: 10px 0; }
        .logout-btn { position: absolute; top: 10px; right: 10px; padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1001; }
        .blinking-marker, .blinking-home-marker { text-align: center; }
        .blinking-marker { font-size: 25px; color: red; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        .blinking-home-marker { font-size: 30px; animation: homeBlink 0.5s infinite; }
        @keyframes homeBlink { 0%, 50% { opacity: 1; transform: scale(1); } 51%, 100% { opacity: 0.5; transform: scale(1.1); } }
    </style>
</head>
<body>
    <!-- ======================================================================= -->
    <!-- [수정됨] 모든 onclick을 제거하고, script에서 제어할 요소에 id를 부여했습니다. -->
    <div id="left-panel">
        <div class="panel-section">
            <h3 class="emergency-drone">Real-time Camera</h3>
            <video id="video" autoplay playsinline muted></video>
            <div id="status" class="status">연결 준비 중...</div>
            <button id="reconnect-camera-btn" class="reconnect-btn">카메라 재연결</button>
            <div id="stats" class="stats"></div>
        </div>
        <div class="panel-section">
            <h3 class="emergency-drone">Drone Control Panel</h3>
            <div>
                <strong>[드론 선택]</strong>
                <select id="droneSelector" class="styled-select">
                    <option value="drone1">Drone 1</option><option value="drone2">Drone 2</option><option value="drone3">Drone 3</option><option value="drone4">Drone 4</option><option value="drone5">Drone 5</option>
                </select>
            </div>
            <div>
                <strong>[드론 전원]</strong>
                <button id="power-btn">드론 전원: OFF</button>
                <div id="reconnect-container"></div>
                <div id="drone-power-status" class="status">드론 상태: 대기 중...</div>
            </div>
            <div>
                <strong>[드론 점검]</strong>
                <button id="inspection-arming-btn">✅ 점검: Arming</button>
                <button id="inspection-hover-btn">🚁 점검: Hover</button>
            </div>
            <div>
                <strong>[드론 주행]</strong>
                <div style="display: flex; gap: 5px;"><button id="sequential-mode-btn">정찰 모드: OFF</button><button id="emergency-mode-btn">응급 모드: OFF</button></div>
            </div>
            <div>
                <strong>[드론 홈]</strong>
                <div style="display: flex; gap: 5px;"><button id="home-btn">🏠 홈 지정</button><button id="emergency-return-btn">비상복귀</button></div>
            </div>
        </div>
    </div>
    
    <div class="main-content-area">
        <div id="map"></div>
        <div id="bottom-panel">
            <div class="panel-section">
                <h3><span id="drone-name">Drone 1</span> 상태</h3>
                <div id="drone-status-container">
                    <p>전원: <span id="status-power">OFF</span></p><p>LTE: <span id="status-lte">OFF</span></p><p>GPS: <span id="status-gps">OFF</span></p>
                    <p>정찰 모드: <span id="status-recon">OFF</span></p><p>응급 모드: <span id="status-emergency">OFF</span></p>
                    <p>배터리: <span id="status-battery">-</span></p>
                </div>
            </div>
            <div class="panel-section">
                <h3>공용 미션 목록</h3>
                <ul id="savedMissions"></ul>
                <button id="save-mission-btn">📌 미션 저장하기</button>
            </div>
        </div>
    </div>
    
    <button id="logout-btn" class="logout-btn">로그아웃</button>
    
    <!-- ======================================================================= -->
    <!-- JavaScript (Script) - 최종 아키텍처 -->
    <!-- ======================================================================= -->
    
    <script>
    // =======================================================================
    // 1. 중앙 상태 저장소 (Single Source of Truth)
    // =======================================================================
    const State = {
        drones: {
            'drone1': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone2': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone3': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone4': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone5': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
        },
        ui: { selectedDroneId: 'drone1', activeMapMode: 'none', },
        missions: { currentMissionPoints: [], savedMissions: [], }
    };
    // =======================================================================
    // 2. 전문가 팀 (The Managers)
    // =======================================================================

    /** UI 렌더링과 관련된 모든 것을 전담하는 객체 */
    const UIManager = {
        elements: {},
        init() {
            const ids = ['power-btn', 'sequential-mode-btn', 'emergency-mode-btn', 'home-btn', 'inspection-arming-btn', 'inspection-hover-btn', 'emergency-return-btn', 'droneSelector', 'map', 'video', 'status', 'stats', 'savedMissions', 'save-mission-btn', 'logout-btn', 'reconnect-container', 'drone-power-status', 'drone-name', 'status-power', 'status-lte', 'status-gps', 'status-recon', 'status-emergency', 'status-battery', 'reconnect-camera-btn'];
            ids.forEach(id => { if(document.getElementById(id)) this.elements[id] = document.getElementById(id); });
        },
        render(state) {
            this.renderControlPanel(state);
            this.renderMissionList(state.missions.savedMissions); // 수정된 renderMissionList 호출
            this.renderDroneStatusPanel(state); // [추가됨] 상세 상태 패널 렌더링
            this.elements.droneSelector.value = state.ui.selectedDroneId;
        },
        renderControlPanel(state) {
            const drone = state.drones[state.ui.selectedDroneId];
            if (!drone) return;

            const { powerState, flightState, hasHome, status } = drone;
            const isFlying = flightState !== 'grounded';
            const isPowerOn = powerState === 'on';
            
            const isReadyToFly = status.battery >= 20 && status.gps === 'GOOD' && status.lte === 'GOOD';
            const canTakeOff = isPowerOn && hasHome && isReadyToFly && !isFlying;

            this.updatePowerUI(drone);

            this.elements['home-btn'].disabled = !isPowerOn || isFlying;
            this.elements['home-btn'].textContent = `🏠 홈 지정 ${state.ui.activeMapMode === 'set_home' ? '(지정 중...)' : ''}`;
            const controlButtons = ['sequential-mode-btn', 'emergency-mode-btn', 'inspection-arming-btn', 'inspection-hover-btn', 'save-mission-btn'];
            controlButtons.forEach(id => { this.elements[id].disabled = !canTakeOff; });

            this.elements['emergency-return-btn'].disabled = !isFlying;
            this.elements['sequential-mode-btn'].style.backgroundColor = state.ui.activeMapMode === 'recon' ? 'green' : '';
            this.elements['emergency-mode-btn'].style.backgroundColor = state.ui.activeMapMode === 'emergency' ? 'red' : '';
        },
        updatePowerUI(drone) {
            const powerBtn = this.elements['power-btn'];
            const powerStatusDiv = this.elements['drone-power-status'];
            const reconnectContainer = this.elements['reconnect-container'];
            
            reconnectContainer.innerHTML = '';
            powerBtn.disabled = false;
            
            switch(drone.powerState) {
                case 'off': powerBtn.textContent = '드론 전원: OFF'; powerBtn.style.backgroundColor = ''; powerStatusDiv.textContent = '드론 상태: 꺼짐'; break;
                case 'turning_on': powerBtn.textContent = '전원 켜는 중...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = '드론 상태: 연결 시도 중...'; break;
                case 'reconnecting': powerBtn.textContent = '재연결 중...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = '드론 상태: 재연결 시도 중...'; break;
                case 'on': powerBtn.textContent = '드론 전원: ON'; powerBtn.style.backgroundColor = 'green'; powerStatusDiv.textContent = '드론 상태: 연결됨'; break;
                case 'turning_off': powerBtn.textContent = '전원 끄는 중...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = '드론 상태: 연결 해제 중...'; break;
                case 'failed':
                    powerBtn.textContent = '드론 전원: 연결 실패'; powerBtn.style.backgroundColor = 'red';
                    powerStatusDiv.textContent = `연결 실패: ${drone.lastError || '알 수 없는 오류'}`;
                    reconnectContainer.innerHTML = `<button onclick="AppController.reconnectDrone()">🔁 드론 재연결</button>`;
                    break;
            }
            if (drone.flightState !== 'grounded') powerBtn.disabled = true;
        },
        renderMissionList(missions) {
            this.elements.savedMissions.innerHTML = '';
            missions.forEach((mission, i) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="text" value="${mission.name}" onchange="AppController.renameMission(${i}, this.value)" style="width: 80px; border: 1px solid #ccc; padding: 4px;">
                    <span>(${mission.points.length} points)</span>
                    <div>
                        <button onclick="AppController.loadMission(${i})">불러오기</button>
                        <button onclick="AppController.startMission(${i})">🚀 시작</button>
                        <button onclick="AppController.deleteSavedMission(${i})">삭제</button>
                    </div>`;
                this.elements.savedMissions.appendChild(li);
            });
        },
        /** [추가됨] 드론 상세 상태 패널(bottom-panel)을 렌더링합니다. */
        renderDroneStatusPanel(state) {
            const drone = state.drones[state.ui.selectedDroneId];
            if (!drone) return;

            this.elements['drone-name'].textContent = state.ui.selectedDroneId;
            this.elements['status-power'].textContent = drone.powerState === 'on' ? 'ON' : 'OFF';
            this.elements['status-lte'].textContent = drone.status.lte;
            this.elements['status-gps'].textContent = drone.status.gps;
            this.elements['status-recon'].textContent = drone.flightState === 'recon_mission' ? 'ON' : 'OFF';
            this.elements['status-emergency'].textContent = drone.flightState === 'emergency_mission' ? 'ON' : 'OFF';
            this.elements['status-battery'].textContent = `${drone.status.battery}%`;
        }
    };

    /** Leaflet 지도와 관련된 모든 것을 전담하는 객체 */
    const MapManager = {
        map: null, markers: [], polyline: null, homeMarker: null, emergencyMarker: null,
        icons: {
            red: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            green: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            yellow: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            blinkingRed: L.divIcon({ className: 'blinking-red-marker', html: `<div class="blinking-marker">📍</div>`, iconSize: [25, 25], iconAnchor: [12, 25] }),
            blinkingYellow: L.divIcon({ className: 'blinking-yellow-marker', html: `<div class="blinking-home-marker">🏠</div>`, iconSize: [32, 32], iconAnchor: [16, 32] }),
            default: new L.Icon.Default()
        },

        init() {
        this.map = L.map('map').setView([37.3402, 126.7335], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(this.map);
        this.map.on('click', (e) => AppController.handleMapClick(e.latlng));
        console.log("✅ MapManager Initialized");
        },
        renderMissionPath(points) {
            this.clearMissionPath();
            
            // 1. 폴리라인 그리기
            const latlngs = points.map(p => [p.lat, p.lng]);
            if (latlngs.length > 1) {
                this.polyline = L.polyline(latlngs, { color: 'blue' }).addTo(this.map);
            }

            // 2. 마커와 라벨 그리기
            points.forEach((pt, i) => {
                let icon = this.icons.default;
                let extraLabel = '';

                if (i === 0) {
                    icon = this.icons.red;
                    extraLabel = 'start point';
                } else if (i === points.length - 1) {
                    icon = this.icons.green;
                    extraLabel = 'end point';
                }

                // 메인 마커 생성 (드래그 가능)
                const marker = L.marker([pt.lat, pt.lng], { icon, draggable: true })
                    .addTo(this.map)
                    .bindPopup(`${extraLabel || 'WayPoint ' + (i + 1)} <button onclick="AppController.deleteMissionPoint(${i})">❌</button>`);
                
                // 마커 드래그 종료 시, 컨트롤러에 위치 변경을 알림
                marker.on('dragend', (e) => {
                    AppController.updateMissionPointPosition(i, e.target.getLatLng());
                });

                // 텍스트 라벨용 마커 생성
                const labelIcon = L.divIcon({
                    className: 'marker-label', // CSS로 스타일 지정 필요
                    html: `<div>${extraLabel}</div>`,
                    iconAnchor: [16, -10]
                });
                const labelMarker = L.marker([pt.lat, pt.lng], { icon: labelIcon }).addTo(this.map);

                this.markers.push(marker);
                this.markers.push(labelMarker); // 라벨 마커도 함께 관리
            });
        },
        clearMissionPath() {
            this.markers.forEach(m => this.map.removeLayer(m));
            this.markers = [];
            if (this.polyline) this.map.removeLayer(this.polyline);
            this.polyline = null;
        },
        setHomeMarker(latlng) {
            if (this.homeMarker) this.map.removeLayer(this.homeMarker);
            this.homeMarker = L.marker([latlng.lat, latlng.lng], { icon: this.icons.yellow }).addTo(this.map).bindPopup("드론 홈 위치").openPopup();
        },
        
        setEmergencyMarker(latlng) {
        this.clearEmergencyMarker(); // 기존 응급 마커가 있다면 지웁니다.
        this.clearMissionPath();     // 다른 미션 경로가 있다면 지웁니다.
        
        this.emergencyMarker = L.marker([latlng.lat, latlng.lng], { icon: this.icons.blinkingRed })
            .addTo(this.map)
            .bindPopup("🚨 응급 위치").openPopup();
        console.log("🗺️ 응급 마커가 설정되었습니다.");
        },
        clearEmergencyMarker() {
        if (this.emergencyMarker) {
            this.map.removeLayer(this.emergencyMarker);
            this.emergencyMarker = null;
            console.log("🗺️ 응급 마커가 제거되었습니다.");
        }
        },
        startBlinkingHomeMarker() {
            if (this.homeMarker) {
                this.homeMarker.setIcon(this.icons.blinkingYellow);
                this.homeMarker.bindPopup("🚨 비상복귀 목적지").openPopup();
            }
        },
        
        stopBlinkingHomeMarker() {
            if (this.homeMarker) {
                this.homeMarker.setIcon(this.icons.yellow);
                this.homeMarker.bindPopup("드론 홈 위치").closePopup();
            }
        }
    };

    const ApiClient = {
        async _post(endpoint, body) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                throw error; // 에러를 상위로 전파
            }
        },
        async _get(endpoint) {
             try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                return await response.json();
            } catch (error) { console.error(`API call to ${endpoint} failed:`, error); throw error; }
        },
        power: (droneId, action) => ApiClient._post(`/drone/${droneId}/power`, { action }),
        inspection: (droneId, mode) => ApiClient._post(`/drone/${droneId}/inspection`, { type: mode }),
        /** [추가됨] 드론 상태를 가져오는 API 호출 함수 */
        getStatus: (droneId) => ApiClient._get(`/drone/${droneId}/status`),
    };

    /** WebRTC 카메라 연결을 전담하는 객체 (이전 코드 통합 및 개선) */
    const WebRTCManager = {
        pc: null, 
        ws: null,
        elements: {}, // UI 요소를 저장할 곳
        droneIpMap: {
            // ❗️이 IP 주소들은 실제 드론의 내부 IP로 반드시 수정해야 합니다.
            'drone1': '192.168.137.86',
            'drone2': '192.168.137.87',
            'drone3': '192.168.137.88',
            'drone4': '192.168.137.89',
            'drone5': '192.168.137.90',
        },
        init(uiElements) {
            this.elements = uiElements;
            console.log("✅ WebRTCManager Initialized");
        },
        connect(droneId) {
            this.disconnect(); // 연결 시작 전, 항상 기존 연결을 깨끗하게 정리
            
            const ip = this.droneIpMap[droneId];
            if (!ip) {
                this.setStatus(`'${droneId}'의 카메라 IP 정보가 없습니다.`, 'error');
                return;
            }
            
            this.setStatus(`'${droneId}' 카메라(${ip}) 연결 시도 중...`, 'info');
            
            try {
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                this.ws = new WebSocket(`ws://${ip}:8765`);
                
                this.setupWebRTCHandlers();
                this.setupWebSocketHandlers();
            } catch (error) {
                console.error("WebRTC 초기화 오류:", error);
                this.setStatus(`초기화 오류: ${error.message}`, 'error');
            }
        },
        disconnect() {
            if (this.pc) this.pc.close();
            if (this.ws) this.ws.close();
            if (this.elements.video) this.elements.video.srcObject = null;
            console.log("📹 WebRTC 연결이 종료되었습니다.");
        },
        setupWebSocketHandlers() {
            this.ws.onopen = async () => {
                this.setStatus("서버 연결됨. 스트리밍 협상 시작...", 'info');
                this.pc.addTransceiver('video', { direction: 'recvonly' });
                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);
                this.ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp, sdpType: offer.type }));
            };
            this.ws.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "answer") {
                        await this.pc.setRemoteDescription(new RTCSessionDescription({ type: data.sdpType, sdp: data.sdp }));
                    } else if (data.type === "candidate" && data.candidate) {
                        await this.pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                } catch (e) { console.error("WS 메시지 처리 오류:", e); }
            };
            this.ws.onerror = () => this.setStatus("카메라 연결 오류. 드론이 실행 중인지 확인하세요.", 'error');
            this.ws.onclose = () => this.setStatus("카메라 연결이 종료되었습니다.", 'warning');
        },
        setupWebRTCHandlers() {
            this.pc.ontrack = (event) => {
                if (event.track.kind === 'video') {
                    this.elements.video.srcObject = event.streams[0];
                    this.elements.video.play().catch(e => console.error("비디오 재생 오류:", e));
                    this.setStatus("카메라 스트리밍 중...", 'success');
                }
            };
            this.pc.oniceconnectionstatechange = () => {
                if (this.elements.stats) this.elements.stats.innerText = `ICE State: ${this.pc.iceConnectionState}`;
            };
        },
        setStatus(message, type = 'info') {
            const statusEl = this.elements.status; // HTML의 id="status"
            if (!statusEl) return;
            statusEl.textContent = message;
            const colorMap = { success: "#d1e7dd", error: "#f8d7da", warning: "#fff3cd", info: "#cff4fc" };
            statusEl.style.backgroundColor = colorMap[type] || colorMap.info;
        }
    };


    // =======================================================================
    // 3. 중앙 관제탑 (The App Controller)
    // =======================================================================
    const AppController = {
        statusUpdateInterval: null, // 주기적 업데이트를 위한 변수

        init() {
            UIManager.init();
            MapManager.init();
            WebRTCManager.init(UIManager.elements);
            this.addEventListeners();
            this.selectDrone(State.ui.selectedDroneId); // 초기 드론 선택 및 상태 업데이트 시작
            UIManager.render(State);
            console.log("✅ Drone Control Center is Online.");
            UIManager.render(State);
        },
        addEventListeners() {
            UIManager.elements.droneSelector.addEventListener('change', (e) => this.selectDrone(e.target.value));
            UIManager.elements['power-btn'].addEventListener('click', () => this.togglePower());
            UIManager.elements['home-btn'].addEventListener('click', () => this.setMapMode('set_home'));
            UIManager.elements['sequential-mode-btn'].addEventListener('click', () => this.setMapMode('recon'));
            UIManager.elements['emergency-mode-btn'].addEventListener('click', () => this.setMapMode('emergency'));
            UIManager.elements['inspection-arming-btn'].addEventListener('click', () => this.inspection('arming'));
            UIManager.elements['inspection-hover-btn'].addEventListener('click', () => this.inspection('hover'));
            UIManager.elements['emergency-return-btn'].addEventListener('click', () => this.emergencyReturn());
            UIManager.elements['save-mission-btn'].addEventListener('click', () => this.saveMission());
            UIManager.elements['logout-btn'].addEventListener('click', () => this.logout());
            const reconnectBtn = document.querySelector('.reconnect-btn'); // 클래스로 찾기
            if(reconnectBtn) reconnectBtn.addEventListener('click', () => this.reconnectCamera());
        },
        /** 드론 선택 시 호출됩니다. */
        selectDrone(droneId) {
            State.ui.selectedDroneId = droneId;
            WebRTCManager.connect(droneId);
            // this.startStatusUpdates(); // [수정됨] 드론을 선택하면 해당 드론의 상태 업데이트를 시작
            UIManager.render(State);
        },     
        
        /** [추가됨] 주기적인 상태 업데이트를 시작/재시작하는 함수 
        startStatusUpdates() {
            if (this.statusUpdateInterval) clearInterval(this.statusUpdateInterval); // 기존 업데이트 중지
            
            this.updateAndRenderStatus(); // 즉시 1회 실행
            
            this.statusUpdateInterval = setInterval(() => {
                this.updateAndRenderStatus();
            }, 5000); // 5초마다 상태 업데이트
        },*/
        /*
        async updateAndRenderStatus() {
            const droneId = State.ui.selectedDroneId;
            try {
                const result = await ApiClient.getStatus(droneId);
                if (result.status === 'success') {
                    // 서버에서 받은 최신 상태로 State 객체를 업데이트
                    State.drones[droneId].status = { ...State.drones[droneId].status, ...result.data };
                }
            } catch (error) {
                console.warn(`${droneId} 상태 업데이트 실패:`, error.message);
                State.drones[droneId].status.lte = 'UNKNOWN'; // 통신 실패 시 상태 변경
            } finally {
                UIManager.render(State); // 성공하든 실패하든 UI는 항상 다시 그림
            }
        },
        */
        
        // [추가됨] 카메라 재연결을 지시하는 함수 
        reconnectCamera() {
            console.log(`📹 ${State.ui.selectedDroneId} 카메라 재연결을 시도합니다...`);
            WebRTCManager.connect(State.ui.selectedDroneId);
        },

        // --- 사용자 액션 처리 ---
        /** 전원 버튼 토글 로직 */
        async togglePower() {
            const droneId = State.ui.selectedDroneId;
            const drone = State.drones[droneId];
            if (drone.flightState !== 'grounded') return alert("비행 중에는 전원을 끌 수 없습니다!");

            const action = (drone.powerState === 'on') ? 'off' : 'on';
            const loadingState = (action === 'on') ? 'turning_on' : 'turning_off';
            
            // 1. UI를 '로딩' 상태로 즉시 변경
            drone.powerState = loadingState;
            UIManager.render(State);

            try {
                // 2. 서버에 명령 전송
                // await ApiClient.power(droneId, action);
                console.log(`API: ${droneId} 전원 ${action}`);
                await new Promise(resolve => setTimeout(resolve, 1500)); // API 호출 시뮬레이션

                // 3. 성공 시 상태 업데이트
                drone.powerState = (action === 'on') ? 'on' : 'off';
                if (action === 'on' && !drone.hasHome) alert(`${droneId}의 전원이 켜졌습니다. 홈 위치를 지정해주세요.`);
                if (action === 'off') {
                    Object.assign(drone, { flightState: 'grounded', hasHome: false, homePosition: null });
                    MapManager.clearMissionPath();
                }

            } catch (error) {
                // 4. 실패 시 상태 업데이트
                drone.powerState = 'failed';
                drone.lastError = error.message;
            } finally {
                // 5. 최종 상태로 UI 다시 렌더링
                UIManager.render(State);
            }
        },

        /** 재연결 로직 */
        async reconnectDrone() {
            const droneId = State.ui.selectedDroneId;
            const drone = State.drones[droneId];

            drone.powerState = 'reconnecting';
            UIManager.render(State);

            try {
                // await ApiClient.power(droneId, 'reconnect');
                console.log(`API: ${droneId} 재연결`);
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                drone.powerState = 'on';
                drone.lastError = null;
            } catch (error) {
                drone.powerState = 'failed';
                drone.lastError = error.message;
            } finally {
                UIManager.render(State);
            }
        },

        /** 지도 모드 변경 로직 */
        setMapMode(modeToToggle) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (drone.powerState !== 'on') return alert("드론 전원을 먼저 켜주세요.");
            if (drone.flightState !== 'grounded' && modeToToggle === 'set_home') return alert("비행 중에는 홈을 재지정할 수 없습니다.");

            const currentMode = State.ui.activeMapMode;
            const isTurningOn = currentMode !== modeToToggle;
            
            const modeKor = { recon: '정찰', emergency: '응급', set_home: '홈 지정' };
            const confirmMsg = isTurningOn ? `'${modeKor[modeToToggle]}' 모드를 활성화하시겠습니까?` : `'${modeKor[modeToToggle]}' 모드를 비활성화하시겠습니까?`;
            
            if (!confirm(confirmMsg)) return;

            // 만약 새로운 모드를 켜는 것이고, 기존에 다른 모드가 켜져 있었다면, 자동 비활성화
            if (isTurningOn && currentMode !== 'none') {
                alert(`'${modeKor[currentMode]}' 모드가 자동으로 비활성화됩니다.`);
                // 기존 모드에 대한 정리 작업 수행
                if (currentMode === 'recon') MapManager.clearMissionPath();
                if (currentMode === 'emergency') MapManager.clearEmergencyMarker();
            }

            // 최종적으로 상태를 변경
            State.ui.activeMapMode = isTurningOn ? modeToToggle : 'none';
            
            // 모드를 명시적으로 끌 때 추가 정리 작업
            if (!isTurningOn) {
                if (modeToToggle === 'recon') MapManager.clearMissionPath();
                if (modeToToggle === 'emergency') MapManager.clearEmergencyMarker();
            }
            
            UIManager.render(State); // 변경된 상태에 따라 전체 UI를 다시 그림
        },

        /** 지도 클릭 핸들러 */
        handleMapClick(latlng) {
            const { activeMapMode, selectedDroneId } = State.ui;
            if (activeMapMode === 'none') return;

            const drone = State.drones[selectedDroneId];
            
            if (activeMapMode === 'set_home') {
                // 1. 상태 변경
                drone.hasHome = true;
                drone.homePosition = latlng;

                // 2. 전문가에게 지시
                MapManager.setHomeMarker(latlng);
                alert(`${selectedDroneId}의 홈 위치가 지정되었습니다.`);
                
                // 3. 모드 자동 종료
                this.setMapMode('set_home'); // 홈 지정 후 모드 자동 종료
            } else if (activeMapMode === 'recon') {
                State.missions.currentMissionPoints.push({ lat: latlng.lat, lng: latlng.lng });
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            } else if (activeMapMode === 'emergency') {
                MapManager.setEmergencyMarker(latlng);
                // ApiClient.sendEmergency(...)
            }

            // ❗️[버그 수정] handleMapClick의 다른 분기(recon, emergency)를 위해
            // 마지막에 UI 렌더링을 한번 더 호출해주는 것이 안전합니다.
            // setMapMode는 내부적으로 render를 호출하므로 'set_home' 케이스는 괜찮지만,
            // 다른 케이스를 위해 추가합니다.
            UIManager.render(State);
        },
        
        /** 미션 시작 */
        startMission(index) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!this._checkPreFlight(drone)) return;

            const mission = State.missions.savedMissions[index];
            if (!mission) return alert("미션을 찾을 수 없습니다.");
            if (confirm(`'${mission.name}' 미션을 시작하시겠습니까?`)) {
                drone.flightState = 'recon_mission';
                UIManager.render(State);
                alert(`${mission.name} 미션 시작!`);
                // ApiClient.startMission(State.ui.selectedDroneId, mission.points);
            }
        },
        
        /** 점검 모드 실행 */
        async inspection(mode) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!this._checkPreFlight(drone)) return;

            const modeText = mode === 'arming' ? 'Arming' : 'Hover';
            if (!confirm(`${modeText} 점검 모드를 실행하시겠습니까?`)) return;
            
            try {
            if (mode === 'hover') {
                // Hover 점검은 비행 시작을 의미함
                drone.flightState = 'hovering';
                UIManager.render(State); // UI를 '비행 중' 상태로 즉시 업데이트
            }
            
            alert(`[${State.ui.selectedDroneId}] ${modeText} 점검 명령 전송...`);
            // const result = await ApiClient.inspection(State.ui.selectedDroneId, mode);
            // alert(`요청 결과: ${result.message}`);
            await new Promise(r => setTimeout(r, 3000)); // API 호출 및 점검 시간 시뮬레이션

            if (mode === 'hover') {
                // Hover 점검이 성공적으로 끝나면, 자동으로 착륙하고 지상 상태로 복귀
                alert("Hover 점검 완료. 자동으로 착륙합니다.");
                drone.flightState = 'grounded'; 
            } else {
                alert("Arming 점검 완료.");
            }

            } catch(err) {
            alert("요청 오류: " + err.message);
            // 오류 발생 시, 비행 상태였다면 지상으로 되돌림
            if(drone.flightState === 'hovering') drone.flightState = 'grounded';
            } finally {
            // 최종적으로 UI를 다시 렌더링하여 버튼 상태를 원래대로 돌려놓음
            UIManager.render(State);
            }
        },
       
        _checkPreFlight(drone) {
            if (drone.powerState !== 'on') { alert("드론 전원이 꺼져 있습니다."); return false; }
            if (!drone.hasHome) { alert("홈 위치를 먼저 지정해야 합니다."); return false; }
            if (drone.status.battery < 20) { alert("배터리가 부족하여 이륙할 수 없습니다."); return false; }
            if (drone.status.gps !== 'GOOD' || drone.status.lte !== 'GOOD') { alert("GPS 또는 LTE 신호가 불안정하여 이륙할 수 없습니다."); return false; }
            return true;
        },

        saveMission() {
            const { currentMissionPoints, savedMissions } = State.missions;
            if (currentMissionPoints.length < 2) return alert("정찰 지점은 2개 이상 필요합니다.");
            const name = prompt("저장할 미션의 이름을 입력하세요:", `미션 ${savedMissions.length + 1}`);
            if (!name) return;
            
            savedMissions.push({ name, points: [...currentMissionPoints] });
            State.missions.currentMissionPoints = [];
            MapManager.clearMissionPath();
            UIManager.render(State);
        },
        
        loadMission(index) {
            const mission = State.missions.savedMissions[index];
            if (mission) {
                State.missions.currentMissionPoints = [...mission.points];
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            }
        },
        
        deleteSavedMission(index) {
            if (confirm("정말로 이 미션을 삭제하시겠습니까?")) {
                State.missions.savedMissions.splice(index, 1);
                UIManager.render(State);
            }
        },
        
        deleteMissionPoint(index) {
            State.missions.currentMissionPoints.splice(index, 1);
            // 상태가 변경되었으므로, MapManager에게 다시 그리라고 지시
            MapManager.renderMissionPath(State.missions.currentMissionPoints);
        },
        
        updateMissionPointPosition(index, newLatLng) {
            if (State.missions.currentMissionPoints[index]) {
                State.missions.currentMissionPoints[index] = { lat: newLatLng.lat, lng: newLatLng.lng };
                // 위치가 바뀌었으니, 경로(Polyline)만 다시 그리도록 지시
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            }
        },

        emergencyReturn() {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!drone.hasHome) return alert("홈 위치가 지정되지 않았습니다.");
            if (confirm("비상복귀를 실행하시겠습니까?")) {
                drone.flightState = 'returning';
                MapManager.startBlinkingHomeMarker(); // 홈 마커 깜빡임 시작
                UIManager.render(State);
                
                const command = {
                    command: 'EMERGENCY_RETURN_TO_HOME',
                    lat: drone.homePosition.lat,
                    lng: drone.homePosition.lng,
                };
                alert(`비상복귀 명령 전송!\n${JSON.stringify(command)}`);
                // ApiClient.emergencyReturn(State.ui.selectedDroneId, command);
                
                // (시뮬레이션) 복귀가 끝나면 상태를 변경하고 마커 깜빡임을 멈춤
                setTimeout(() => {
                    drone.flightState = 'grounded';
                    MapManager.stopBlinkingHomeMarker();
                    UIManager.render(State);
                    alert("비상복귀 완료.");
                }, 5000);
            }
        },
        
        logout() {
            if (confirm("로그아웃 하시겠습니까?")) {
                window.location.href = "/logout";
            }
        },
    
        renameMission(index, newName) {
            if (State.missions.savedMissions[index]) {
                State.missions.savedMissions[index].name = newName.trim();
                console.log(`미션 ${index}의 이름이 '${newName.trim()}'으로 변경되었습니다.`);
                // UIManager.render(State)를 호출할 수도 있지만, 이름 변경은 실시간으로 반영되므로 필수는 아님
            }
        }
    };

    // =======================================================================
    // 4. 애플리케이션 시작
    // =======================================================================
    window.addEventListener('load', () => AppController.init());
    window.addEventListener('beforeunload', () => WebRTCManager.disconnect());
</script>
</body>
</html>
