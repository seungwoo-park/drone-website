<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drone Map Mode</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        /* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•˜ë©°, ë ˆì´ì•„ì›ƒ ë¬¸ì œë¥¼ í•´ê²°í•œ ìµœì¢… ë²„ì „ì…ë‹ˆë‹¤. */
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f4ff; overflow: hidden; }
        body { display: flex; flex-direction: row; }
        #left-panel { width: 30%; min-width: 400px; height: 100vh; display: flex; flex-direction: column; background: #ffffff; border-right: 1px solid #ddd; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10;}
        .main-content-area { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        #map { flex: 1; background-color: #e5e5e5; }
        #bottom-panel { height: 33%; min-height: 250px; display: flex; background: #fafafa; border-top: 1px solid #ddd; overflow: hidden; }
        .panel-section { flex: 1; padding: 15px; box-sizing: border-box; border-right: 1px solid #eee; overflow-y: auto; }
        .panel-section:last-child { border-right: none; }
        .panel-section h3, .emergency-drone { font-size: 18px; font-weight: bold; color: #007bff; margin-top: 0; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .panel-section button { padding: 8px 12px; margin: 4px 2px; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; font-weight: 500; width: 100%; transition: background-color 0.2s; }
        .panel-section button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .panel-section button:hover:not(:disabled) { background-color: #0056b3; }
        .panel-section strong { display: block; margin-top: 15px; margin-bottom: 5px; }
        .button-group { display: flex; gap: 5px; }
        #video { border: 2px solid #007bff; border-radius: 8px; background-color: #000; width: 100%; height: auto; margin-top: 10px;}
        .reconnect-btn { background-color: #ffc107; color: black; }
        .status, #drone-power-status { margin-top: 10px; border-radius: 8px; padding: 8px; text-align: center; }
        .stats { margin-top: 10px; padding: 8px; background: #e9f5ff; border-radius: 6px; font-family: monospace; font-size: 12px; }
        #savedMissions { list-style: none; padding: 0; }
        #savedMissions li { background: #e7f1ff; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px; }
        #savedMissions li button { width: auto; font-size: 12px; padding: 4px 8px; }
        .styled-select { display: block; width: 100%; padding: 10px; border: 1px solid #007bff; border-radius: 8px; margin: 10px 0; }
        .logout-btn { position: absolute; top: 10px; right: 10px; padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1001; }
        .blinking-marker, .blinking-home-marker { text-align: center; }
        .blinking-marker { font-size: 25px; color: red; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        .blinking-home-marker { font-size: 30px; animation: homeBlink 0.5s infinite; }
        @keyframes homeBlink { 0%, 50% { opacity: 1; transform: scale(1); } 51%, 100% { opacity: 0.5; transform: scale(1.1); } }
        
        /* [ìˆ˜ì •ë¨] Leaflet ì»¨íŠ¸ë¡¤ì„ ìœ„í•œ ê³µì‹ì ì¸ ìŠ¤íƒ€ì¼ */
        .leaflet-control-custom a {
            background-color: white;
            width: 34px;
            height: 34px;
            line-height: 34px;
            text-align: center;
            text-decoration: none;
            color: black;
            font-size: 1.5rem;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            display: block;
        }
        .leaflet-control-custom a:hover {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <!-- ======================================================================= -->
    <!-- ======================================================================= -->
    <!-- 1. ì™¼ìª½ ì œì–´íŒ ì˜ì—­ -->
    <!-- ======================================================================= -->
    <!-- [ìˆ˜ì •ë¨] Body êµ¬ì¡°: ì§€ë„ ìœ„ì— ë–  ìˆëŠ” ë²„íŠ¼ë“¤ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ë¯€ë¡œ, HTMLì—ì„œëŠ” ì œê±°í•©ë‹ˆë‹¤. -->
    <div id="left-panel">
        <div class="panel-section">
            <h3 class="emergency-drone">Real-time Camera</h3>
            <video id="video" autoplay playsinline muted></video>
            <div id="status" class="status">ì—°ê²° ì¤€ë¹„ ì¤‘...</div>
            <button id="reconnect-camera-btn" class="reconnect-btn">ì¹´ë©”ë¼ ì¬ì—°ê²°</button>
            <div id="stats" class="stats"></div>
        </div>
        <div class="panel-section">
            <h3 class="emergency-drone">Drone Control Panel</h3>
            <div><strong>[ë“œë¡  ì„ íƒ]</strong><select id="droneSelector" class="styled-select"><option value="drone1">Drone 1</option><option value="drone2">Drone 2</option><option value="drone3">Drone 3</option><option value="drone4">Drone 4</option><option value="drone5">Drone 5</option></select></div>
            <div><strong>[ë“œë¡  ì „ì›]</strong><button id="power-btn">ë“œë¡  ì „ì›: OFF</button><div id="reconnect-container"></div><div id="drone-power-status" class="status">ë“œë¡  ìƒíƒœ: ëŒ€ê¸° ì¤‘...</div></div>
            <div><strong>[ë“œë¡  ì ê²€]</strong><div class="button-group"><button id="inspection-arming-btn">âœ… Arming</button><button id="inspection-hover-btn">ğŸš Hover</button><button id="inspection-drop-btn">ğŸ“¦ íˆ¬í•˜ ì ê²€</button></div></div>
            <div><strong>[ë“œë¡  ì£¼í–‰]</strong><div class="button-group"><button id="sequential-mode-btn">ì •ì°° ëª¨ë“œ: OFF</button><button id="emergency-mode-btn">ì‘ê¸‰ ëª¨ë“œ: OFF</button></div></div>
            <div><strong>[ë“œë¡  í™ˆ]</strong><div class="button-group"><button id="home-btn">ğŸ  í™ˆ ì§€ì •</button><button id="emergency-return-btn">ë¹„ìƒë³µê·€</button><button id="inflight-drop-btn">ğŸ’§ ë¬¼í’ˆ íˆ¬í•˜</button></div></div>
        </div>
    </div>
    
    <div class="main-content-area">
        <div id="map"></div>
        <div id="bottom-panel">
            <div class="panel-section"><h3><span id="drone-name">Drone 1</span> ìƒíƒœ</h3><div id="drone-status-container"><p>ì „ì›: <span id="status-power">OFF</span></p><p>ë¹„í–‰ìƒíƒœ: <span id="status-flight">Grounded</span></p><p>LTE: <span id="status-lte">OFF</span></p><p>GPS: <span id="status-gps">OFF</span></p><p>ë°°í„°ë¦¬: <span id="status-battery">-</span></p></div></div>
            <div class="panel-section"><h3>ê³µìš© ë¯¸ì…˜ ëª©ë¡</h3><ul id="savedMissions"></ul><button id="save-mission-btn">ï¿½ ë¯¸ì…˜ ì €ì¥í•˜ê¸°</button></div>
        </div>
    </div>
    
    <button id="logout-btn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>

    <script>
    // =======================================================================
    // 1. ì¤‘ì•™ ìƒíƒœ ì €ì¥ì†Œ (Single Source of Truth)
    // =======================================================================
    const State = {
        drones: {
            'drone1': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone2': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone3': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone4': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
            'drone5': { powerState: 'off', flightState: 'grounded', hasHome: false, homePosition: null, status: { battery: 100, gps: 'GOOD', lte: 'GOOD' }, lastError: null },
        },
        ui: { selectedDroneId: 'drone1', activeMapMode: 'none', },
        missions: { currentMissionPoints: [], savedMissions: [], }
    };
    // =======================================================================
    // 2. ì „ë¬¸ê°€ íŒ€ (The Managers)
    // =======================================================================

    /** UI ë Œë”ë§ê³¼ ê´€ë ¨ëœ ëª¨ë“  ê²ƒì„ ì „ë‹´í•˜ëŠ” ê°ì²´ */
    const UIManager = {
        elements: {},
        init() {
            const ids = ['power-btn', 'sequential-mode-btn', 'emergency-mode-btn', 'home-btn', 'inspection-arming-btn', 'inspection-hover-btn', 'emergency-return-btn', 'droneSelector', 'map', 'video', 'status', 'stats', 'savedMissions', 'save-mission-btn', 'logout-btn', 'reconnect-container', 'drone-power-status', 'drone-name', 'status-power', 'status-lte', 'status-gps', 'status-flight', 'status-recon', 'status-emergency', 'status-battery', 'reconnect-camera-btn', 'inspection-drop-btn', 'inflight-drop-btn'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) this.elements[id] = el;
                else console.warn(`UI Element not found: #${id}`); // [ìˆ˜ì •ë¨] ì—†ëŠ” ìš”ì†Œì— ëŒ€í•´ ê²½ê³ ë§Œ í•˜ê³  ë©ˆì¶”ì§€ ì•ŠìŒ
            });
        },
        render(state) {
            this.renderControlPanel(state);
            this.renderMissionList(state.missions.savedMissions);
            this.renderDroneStatusPanel(state);
            if (this.elements.droneSelector) this.elements.droneSelector.value = state.ui.selectedDroneId;
        },
        renderControlPanel(state) {
            const drone = state.drones[state.ui.selectedDroneId];
            if (!drone) return;
            const { powerState, flightState, hasHome, status } = drone;
            const isFlying = flightState !== 'grounded';
            const isPowerOn = powerState === 'on';
            const isReadyToFly = status.battery >= 20 && status.gps === 'GOOD' && status.lte === 'GOOD';
            const canTakeOff = isPowerOn && hasHome && isReadyToFly && !isFlying;

            this.updatePowerUI(drone);

            const controlButtons = {
                'home-btn': !isPowerOn || isFlying, 'sequential-mode-btn': !canTakeOff,
                'emergency-mode-btn': !canTakeOff, 'save-mission-btn': !canTakeOff,
                'inspection-arming-btn': !canTakeOff, 'inspection-hover-btn': !canTakeOff,
                'inspection-drop-btn': !canTakeOff, 'emergency-return-btn': !isFlying,
                'inflight-drop-btn': !isFlying,
            };
            
            // [ìˆ˜ì •ë¨] ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ disabled ì†ì„± ë³€ê²½
            for (const [id, isDisabled] of Object.entries(controlButtons)) {
                if (this.elements[id]) this.elements[id].disabled = isDisabled;
            }
            
            if (this.elements['home-btn']) this.elements['home-btn'].textContent = `ğŸ  í™ˆ ì§€ì • ${state.ui.activeMapMode === 'set_home' ? '(ì§€ì • ì¤‘...)' : ''}`;
            if (this.elements['sequential-mode-btn']) this.elements['sequential-mode-btn'].style.backgroundColor = state.ui.activeMapMode === 'recon' ? 'green' : '';
            if (this.elements['emergency-mode-btn']) this.elements['emergency-mode-btn'].style.backgroundColor = state.ui.activeMapMode === 'emergency' ? 'red' : '';
        },
        updatePowerUI(drone) {
            const powerBtn = this.elements['power-btn'];
            const powerStatusDiv = this.elements['drone-power-status'];
            const reconnectContainer = this.elements['reconnect-container'];
            
            reconnectContainer.innerHTML = '';
            powerBtn.disabled = false;
            
            switch(drone.powerState) {
                case 'off': powerBtn.textContent = 'ë“œë¡  ì „ì›: OFF'; powerBtn.style.backgroundColor = ''; powerStatusDiv.textContent = 'ë“œë¡  ìƒíƒœ: êº¼ì§'; break;
                case 'turning_on': powerBtn.textContent = 'ì „ì› ì¼œëŠ” ì¤‘...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = 'ë“œë¡  ìƒíƒœ: ì—°ê²° ì‹œë„ ì¤‘...'; break;
                case 'reconnecting': powerBtn.textContent = 'ì¬ì—°ê²° ì¤‘...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = 'ë“œë¡  ìƒíƒœ: ì¬ì—°ê²° ì‹œë„ ì¤‘...'; break;
                case 'on': powerBtn.textContent = 'ë“œë¡  ì „ì›: ON'; powerBtn.style.backgroundColor = 'green'; powerStatusDiv.textContent = 'ë“œë¡  ìƒíƒœ: ì—°ê²°ë¨'; break;
                case 'turning_off': powerBtn.textContent = 'ì „ì› ë„ëŠ” ì¤‘...'; powerBtn.style.backgroundColor = 'gray'; powerBtn.disabled = true; powerStatusDiv.textContent = 'ë“œë¡  ìƒíƒœ: ì—°ê²° í•´ì œ ì¤‘...'; break;
                case 'failed':
                    powerBtn.textContent = 'ë“œë¡  ì „ì›: ì—°ê²° ì‹¤íŒ¨'; powerBtn.style.backgroundColor = 'red';
                    powerStatusDiv.textContent = `ì—°ê²° ì‹¤íŒ¨: ${drone.lastError || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    reconnectContainer.innerHTML = `<button onclick="AppController.reconnectDrone()">ğŸ” ë“œë¡  ì¬ì—°ê²°</button>`;
                    break;
            }
            if (drone.flightState !== 'grounded') powerBtn.disabled = true;
        },
        renderMissionList(missions) {
            this.elements.savedMissions.innerHTML = '';
            missions.forEach((mission, i) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="text" value="${mission.name}" onchange="AppController.renameMission(${i}, this.value)" style="width: 80px; border: 1px solid #ccc; padding: 4px;">
                    <span>(${mission.points.length} points)</span>
                    <div>
                        <button onclick="AppController.loadMission(${i})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="AppController.startMission(${i})">ğŸš€ ì‹œì‘</button>
                        <button onclick="AppController.deleteSavedMission(${i})">ì‚­ì œ</button>
                    </div>`;
                this.elements.savedMissions.appendChild(li);
            });
        },
        /** [ì¶”ê°€ë¨] ë“œë¡  ìƒì„¸ ìƒíƒœ íŒ¨ë„(bottom-panel)ì„ ë Œë”ë§í•©ë‹ˆë‹¤. */
        renderDroneStatusPanel(state) {
            const drone = state.drones[state.ui.selectedDroneId];
            if (!drone) return;
            
            // [ìˆ˜ì •ë¨] ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ textContent ë³€ê²½
            const setText = (id, text) => { if (this.elements[id]) this.elements[id].textContent = text; };
            
            setText('drone-name', state.ui.selectedDroneId);
            setText('status-power', drone.powerState === 'on' ? 'ON' : 'OFF');
            setText('status-flight', drone.flightState); // ë¹„í–‰ ìƒíƒœ í‘œì‹œ
            setText('status-lte', drone.status.lte);
            setText('status-gps', drone.status.gps);
            setText('status-recon', drone.flightState === 'recon_mission' ? 'ON' : 'OFF');
            setText('status-emergency', drone.flightState === 'emergency_mission' ? 'ON' : 'OFF');
            setText('status-battery', `${drone.status.battery}%`);
        }
    };

    /** Leaflet ì§€ë„ì™€ ê´€ë ¨ëœ ëª¨ë“  ê²ƒì„ ì „ë‹´í•˜ëŠ” ê°ì²´ */
    const MapManager = {
        map: null, markers: [], polyline: null, homeMarker: null, emergencyMarker: null,
        icons: {
            red: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            green: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            yellow: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png', iconSize: [32, 32], iconAnchor: [16, 32]}),
            blinkingRed: L.divIcon({ className: 'blinking-red-marker', html: `<div class="blinking-marker">ğŸ“</div>`, iconSize: [25, 25], iconAnchor: [12, 25] }),
            blinkingYellow: L.divIcon({ className: 'blinking-yellow-marker', html: `<div class="blinking-home-marker">ğŸ </div>`, iconSize: [32, 32], iconAnchor: [16, 32] }),
            default: new L.Icon.Default()
        },

        init() {
            this.map = L.map('map').setView([37.3402, 126.7335], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(this.map);
            this.map.on('click', (e) => AppController.handleMapClick(e.latlng));
            this.addUserLocationButton(); // Leaflet ì»¨íŠ¸ë¡¤ ë°©ì‹ìœ¼ë¡œ ë²„íŠ¼ ì¶”ê°€
            console.log("âœ… MapManager Initialized");
        },
        addUserLocationButton() {
            L.Control.UserLocation = L.Control.extend({
                options: { position: 'bottomright' },
                onAdd: function (map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    const button = L.DomUtil.create('a', '', container);
                    button.innerHTML = 'ğŸ¯';
                    button.href = '#';
                    button.role = 'button';
                    button.title = 'ë‚´ ìœ„ì¹˜ë¡œ ì´ë™';

                    // ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒë¥¼ ë§‰ê³ , ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                    L.DomEvent.on(button, 'click', L.DomEvent.stop);
                    L.DomEvent.on(button, 'click', AppController.centerOnUser, AppController);
                    return container;
                }
            });
            new L.Control.UserLocation().addTo(this.map);
        },
        animateDronePath(droneId, path, duration = 5000) {
            const drone = State.drones[droneId];
            if (!this.droneMarker) { // ë“œë¡  ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ìƒì„±
                this.droneMarker = L.marker(path[0], { icon: this.icons.green }).addTo(this.map);
            }
            
            let startTime = performance.now();
            const animate = (currentTime) => {
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                
                const totalDistance = path.reduce((sum, _, i) => {
                    if (i === 0) return 0;
                    const p1 = L.latLng(path[i-1]);
                    const p2 = L.latLng(path[i]);
                    return sum + p1.distanceTo(p2);
                }, 0);

                let traveledDistance = totalDistance * progress;
                for (let i = 1; i < path.length; i++) {
                    const segmentStart = L.latLng(path[i-1]);
                    const segmentEnd = L.latLng(path[i]);
                    const segmentDistance = segmentStart.distanceTo(segmentEnd);

                    if (traveledDistance <= segmentDistance) {
                        const segmentProgress = traveledDistance / segmentDistance;
                        const currentLatLng = [
                            segmentStart.lat + (segmentEnd.lat - segmentStart.lat) * segmentProgress,
                            segmentStart.lng + (segmentEnd.lng - segmentStart.lng) * segmentProgress
                        ];
                        this.droneMarker.setLatLng(currentLatLng);
                        break;
                    }
                    traveledDistance -= segmentDistance;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    AppController.completeMission(droneId);
                }
            };
            requestAnimationFrame(animate);
        },


        renderMissionPath(points) {
            this.clearMissionPath();
            
            // 1. í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
            const latlngs = points.map(p => [p.lat, p.lng]);
            if (latlngs.length > 1) {
                this.polyline = L.polyline(latlngs, { color: 'blue' }).addTo(this.map);
            }

            // 2. ë§ˆì»¤ì™€ ë¼ë²¨ ê·¸ë¦¬ê¸°
            points.forEach((pt, i) => {
                let icon = this.icons.default;
                let extraLabel = '';

                if (i === 0) {
                    icon = this.icons.red;
                    extraLabel = 'start point';
                } else if (i === points.length - 1) {
                    icon = this.icons.green;
                    extraLabel = 'end point';
                }

                // ë©”ì¸ ë§ˆì»¤ ìƒì„± (ë“œë˜ê·¸ ê°€ëŠ¥)
                const marker = L.marker([pt.lat, pt.lng], { icon, draggable: true })
                    .addTo(this.map)
                    .bindPopup(`${extraLabel || 'WayPoint ' + (i + 1)} <button onclick="AppController.deleteMissionPoint(${i})">âŒ</button>`);
                
                // ë§ˆì»¤ ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ, ì»¨íŠ¸ë¡¤ëŸ¬ì— ìœ„ì¹˜ ë³€ê²½ì„ ì•Œë¦¼
                marker.on('dragend', (e) => {
                    AppController.updateMissionPointPosition(i, e.target.getLatLng());
                });

                // í…ìŠ¤íŠ¸ ë¼ë²¨ìš© ë§ˆì»¤ ìƒì„±
                const labelIcon = L.divIcon({
                    className: 'marker-label', // CSSë¡œ ìŠ¤íƒ€ì¼ ì§€ì • í•„ìš”
                    html: `<div>${extraLabel}</div>`,
                    iconAnchor: [16, -10]
                });
                const labelMarker = L.marker([pt.lat, pt.lng], { icon: labelIcon }).addTo(this.map);

                this.markers.push(marker);
                this.markers.push(labelMarker); // ë¼ë²¨ ë§ˆì»¤ë„ í•¨ê»˜ ê´€ë¦¬
            });
        },
        clearMissionPath() {
            this.markers.forEach(m => this.map.removeLayer(m));
            this.markers = [];
            if (this.polyline) this.map.removeLayer(this.polyline);
            this.polyline = null;
        },
        setHomeMarker(latlng) {
            if (this.homeMarker) this.map.removeLayer(this.homeMarker);
            this.homeMarker = L.marker([latlng.lat, latlng.lng], { icon: this.icons.yellow }).addTo(this.map).bindPopup("ë“œë¡  í™ˆ ìœ„ì¹˜").openPopup();
        },
        
        setEmergencyMarker(latlng) {
            this.clearEmergencyMarker();
            this.clearMissionPath();
            
            const popupContent = `
                <strong style="color: red;">ğŸš¨ ì‘ê¸‰ ìœ„ì¹˜</strong><br>
                ì¢Œí‘œ: (${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)})
                <br>
                <button class="popup-button" onclick="AppController.startEmergencyMission({lat: ${latlng.lat}, lng: ${latlng.lng}})">
                    ğŸš€ ì‘ê¸‰ ì¶œë™
                </button>
            `;
            
            this.emergencyMarker = L.marker([latlng.lat, latlng.lng], { icon: this.icons.blinkingRed })
                .addTo(this.map)
                .bindPopup(popupContent)
                .openPopup();
        },
        clearEmergencyMarker() {
        if (this.emergencyMarker) {
            this.map.removeLayer(this.emergencyMarker);
            this.emergencyMarker = null;
            console.log("ğŸ—ºï¸ ì‘ê¸‰ ë§ˆì»¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        },
        startBlinkingHomeMarker() {
            if (this.homeMarker) {
                this.homeMarker.setIcon(this.icons.blinkingYellow);
                this.homeMarker.bindPopup("ğŸš¨ ë¹„ìƒë³µê·€ ëª©ì ì§€").openPopup();
            }
        },
        
        stopBlinkingHomeMarker() {
            if (this.homeMarker) {
                this.homeMarker.setIcon(this.icons.yellow);
                this.homeMarker.bindPopup("ë“œë¡  í™ˆ ìœ„ì¹˜").closePopup();
            }
        },
        
        /** [ìˆ˜ì •ë¨] ì§€ë„ë¥¼ íŠ¹ì • ì¢Œí‘œë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™ì‹œí‚¤ëŠ” ì±…ì„ */
        panTo(latlng) {
            if(this.map && latlng) {
                this.map.panTo(new L.LatLng(latlng.lat, latlng.lng));
            }
        },
        
        /** [ìˆ˜ì •ë¨] ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•˜ëŠ” ì±…ì„ */
        showUserMarker(latlng) {
            if (!this.map) return;
            const popupContent = "ì‚¬ìš©ì í˜„ì¬ ìœ„ì¹˜";
            if (this.userMarker) {
                this.userMarker.setLatLng(latlng).setPopupContent(popupContent).openPopup();
            } else {
                this.userMarker = L.marker([latlng.lat, latlng.lng]).addTo(this.map)
                    .bindPopup(popupContent).openPopup();
            }
        },
    };

    const ApiClient = {
        async _post(endpoint, body) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                throw error; // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „íŒŒ
            }
        },
        async _get(endpoint) {
             try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                return await response.json();
            } catch (error) { console.error(`API call to ${endpoint} failed:`, error); throw error; }
        },
        power: (droneId, action) => ApiClient._post(`/drone/${droneId}/power`, { action }),
        inspection: (droneId, mode) => ApiClient._post(`/drone/${droneId}/inspection`, { type: mode }),
        /** [ì¶”ê°€ë¨] ë“œë¡  ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ í•¨ìˆ˜ */
        getStatus: (droneId) => ApiClient._get(`/drone/${droneId}/status`),
    };

    /** WebRTC ì¹´ë©”ë¼ ì—°ê²°ì„ ì „ë‹´í•˜ëŠ” ê°ì²´ (ì´ì „ ì½”ë“œ í†µí•© ë° ê°œì„ ) */
    const WebRTCManager = {
        pc: null, 
        ws: null,
        elements: {}, // UI ìš”ì†Œë¥¼ ì €ì¥í•  ê³³
        droneIpMap: {
            // â—ï¸ì´ IP ì£¼ì†Œë“¤ì€ ì‹¤ì œ ë“œë¡ ì˜ ë‚´ë¶€ IPë¡œ ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            'drone1': '192.168.137.86',
            'drone2': '192.168.137.87',
            'drone3': '192.168.137.88',
            'drone4': '192.168.137.89',
            'drone5': '192.168.137.90',
        },
        init(uiElements) {
            this.elements = uiElements;
            console.log("âœ… WebRTCManager Initialized");
        },
        connect(droneId) {
            this.disconnect(); // ì—°ê²° ì‹œì‘ ì „, í•­ìƒ ê¸°ì¡´ ì—°ê²°ì„ ê¹¨ë—í•˜ê²Œ ì •ë¦¬
            
            const ip = this.droneIpMap[droneId];
            if (!ip) {
                this.setStatus(`'${droneId}'ì˜ ì¹´ë©”ë¼ IP ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                return;
            }
            
            this.setStatus(`'${droneId}' ì¹´ë©”ë¼(${ip}) ì—°ê²° ì‹œë„ ì¤‘...`, 'info');
            
            try {
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                this.ws = new WebSocket(`ws://${ip}:8765`);
                
                this.setupWebRTCHandlers();
                this.setupWebSocketHandlers();
            } catch (error) {
                console.error("WebRTC ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                this.setStatus(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        },
        disconnect() {
            if (this.pc) this.pc.close();
            if (this.ws) this.ws.close();
            if (this.elements.video) this.elements.video.srcObject = null;
            console.log("ğŸ“¹ WebRTC ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        },
        setupWebSocketHandlers() {
            this.ws.onopen = async () => {
                this.setStatus("ì„œë²„ ì—°ê²°ë¨. ìŠ¤íŠ¸ë¦¬ë° í˜‘ìƒ ì‹œì‘...", 'info');
                this.pc.addTransceiver('video', { direction: 'recvonly' });
                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);
                this.ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp, sdpType: offer.type }));
            };
            this.ws.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "answer") {
                        await this.pc.setRemoteDescription(new RTCSessionDescription({ type: data.sdpType, sdp: data.sdp }));
                    } else if (data.type === "candidate" && data.candidate) {
                        await this.pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                } catch (e) { console.error("WS ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", e); }
            };
            this.ws.onerror = () => this.setStatus("ì¹´ë©”ë¼ ì—°ê²° ì˜¤ë¥˜. ë“œë¡ ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.", 'error');
            this.ws.onclose = () => this.setStatus("ì¹´ë©”ë¼ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'warning');
        },
        setupWebRTCHandlers() {
            this.pc.ontrack = (event) => {
                if (event.track.kind === 'video') {
                    this.elements.video.srcObject = event.streams[0];
                    this.elements.video.play().catch(e => console.error("ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", e));
                    this.setStatus("ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° ì¤‘...", 'success');
                }
            };
            this.pc.oniceconnectionstatechange = () => {
                if (this.elements.stats) this.elements.stats.innerText = `ICE State: ${this.pc.iceConnectionState}`;
            };
        },
        setStatus(message, type = 'info') {
            const statusEl = this.elements.status; // HTMLì˜ id="status"
            if (!statusEl) return;
            statusEl.textContent = message;
            const colorMap = { success: "#d1e7dd", error: "#f8d7da", warning: "#fff3cd", info: "#cff4fc" };
            statusEl.style.backgroundColor = colorMap[type] || colorMap.info;
        }
    };


    // =======================================================================
    // 3. ì¤‘ì•™ ê´€ì œíƒ‘ (The App Controller)
    // =======================================================================
    const AppController = {
        statusUpdateInterval: null, // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë³€ìˆ˜

        init() {
            UIManager.init();
            MapManager.init();
            WebRTCManager.init(UIManager.elements);
            this.addEventListeners();
            this.selectDrone(State.ui.selectedDroneId); // ì´ˆê¸° ë“œë¡  ì„ íƒ ë° ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘
            UIManager.render(State);
            console.log("âœ… Drone Control Center is Online.");
            UIManager.render(State);
        },
        addEventListeners() {
            // [ìˆ˜ì •ë¨] user-location-btnì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            // MapManagerê°€ Leafletì˜ ê³µì‹ì ì¸ ë°©ì‹ìœ¼ë¡œ ì§ì ‘ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
            const actionMap = {
                'droneSelector': (e) => this.selectDrone(e.target.value), 'power-btn': () => this.togglePower(),
                'home-btn': () => this.setMapMode('set_home'), 'sequential-mode-btn': () => this.setMapMode('recon'),
                'emergency-mode-btn': () => this.setMapMode('emergency'), 'inspection-arming-btn': () => this.inspection('arming'),
                'inspection-hover-btn': () => this.inspection('hover'), 'inspection-drop-btn': () => this.inspection('drop'),
                'emergency-return-btn': () => this.emergencyReturn(), 'inflight-drop-btn': () => this.inFlightDrop(),
                'save-mission-btn': () => this.saveMission(), 'logout-btn': () => this.logout(),
                'reconnect-camera-btn': () => this.reconnectCamera()
            };
            for (const [id, handler] of Object.entries(actionMap)) {
                const el = UIManager.elements[id];
                if (el) {
                    const eventType = el.tagName === 'SELECT' ? 'change' : 'click';
                    el.addEventListener(eventType, handler);
                }
            }
        },
        /** ë“œë¡  ì„ íƒ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. */
        selectDrone(droneId) {
            State.ui.selectedDroneId = droneId;
            WebRTCManager.connect(droneId);
            // this.startStatusUpdates(); // [ìˆ˜ì •ë¨] ë“œë¡ ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ë“œë¡ ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘
            UIManager.render(State);
        },     
        
        /** [ì¶”ê°€ë¨] ì£¼ê¸°ì ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘/ì¬ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ 
        startStatusUpdates() {
            if (this.statusUpdateInterval) clearInterval(this.statusUpdateInterval); // ê¸°ì¡´ ì—…ë°ì´íŠ¸ ì¤‘ì§€
            
            this.updateAndRenderStatus(); // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
            
            this.statusUpdateInterval = setInterval(() => {
                this.updateAndRenderStatus();
            }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        },*/
        /*
        async updateAndRenderStatus() {
            const droneId = State.ui.selectedDroneId;
            try {
                const result = await ApiClient.getStatus(droneId);
                if (result.status === 'success') {
                    // ì„œë²„ì—ì„œ ë°›ì€ ìµœì‹  ìƒíƒœë¡œ State ê°ì²´ë¥¼ ì—…ë°ì´íŠ¸
                    State.drones[droneId].status = { ...State.drones[droneId].status, ...result.data };
                }
            } catch (error) {
                console.warn(`${droneId} ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error.message);
                State.drones[droneId].status.lte = 'UNKNOWN'; // í†µì‹  ì‹¤íŒ¨ ì‹œ ìƒíƒœ ë³€ê²½
            } finally {
                UIManager.render(State); // ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“  UIëŠ” í•­ìƒ ë‹¤ì‹œ ê·¸ë¦¼
            }
        },
        */
        
        // [ì¶”ê°€ë¨] ì¹´ë©”ë¼ ì¬ì—°ê²°ì„ ì§€ì‹œí•˜ëŠ” í•¨ìˆ˜ 
        reconnectCamera() {
            console.log(`ğŸ“¹ ${State.ui.selectedDroneId} ì¹´ë©”ë¼ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
            WebRTCManager.connect(State.ui.selectedDroneId);
        },

        // --- ì‚¬ìš©ì ì•¡ì…˜ ì²˜ë¦¬ ---
        /** ì „ì› ë²„íŠ¼ í† ê¸€ ë¡œì§ */
        async togglePower() {
            const droneId = State.ui.selectedDroneId;
            const drone = State.drones[droneId];
            if (drone.flightState !== 'grounded') return alert("ë¹„í–‰ ì¤‘ì—ëŠ” ì „ì›ì„ ëŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");

            const action = (drone.powerState === 'on') ? 'off' : 'on';
            const loadingState = (action === 'on') ? 'turning_on' : 'turning_off';
            
            // 1. UIë¥¼ 'ë¡œë”©' ìƒíƒœë¡œ ì¦‰ì‹œ ë³€ê²½
            drone.powerState = loadingState;
            UIManager.render(State);

            try {
                // 2. ì„œë²„ì— ëª…ë ¹ ì „ì†¡
                // await ApiClient.power(droneId, action);
                console.log(`API: ${droneId} ì „ì› ${action}`);
                await new Promise(resolve => setTimeout(resolve, 1500)); // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜

                // 3. ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                drone.powerState = (action === 'on') ? 'on' : 'off';
                if (action === 'on' && !drone.hasHome) alert(`${droneId}ì˜ ì „ì›ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤. í™ˆ ìœ„ì¹˜ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.`);
                if (action === 'off') {
                    Object.assign(drone, { flightState: 'grounded', hasHome: false, homePosition: null });
                    MapManager.clearMissionPath();
                }

            } catch (error) {
                // 4. ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                drone.powerState = 'failed';
                drone.lastError = error.message;
            } finally {
                // 5. ìµœì¢… ìƒíƒœë¡œ UI ë‹¤ì‹œ ë Œë”ë§
                UIManager.render(State);
            }
        },

        /** ì¬ì—°ê²° ë¡œì§ */
        async reconnectDrone() {
            const droneId = State.ui.selectedDroneId;
            const drone = State.drones[droneId];

            drone.powerState = 'reconnecting';
            UIManager.render(State);

            try {
                // await ApiClient.power(droneId, 'reconnect');
                console.log(`API: ${droneId} ì¬ì—°ê²°`);
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                drone.powerState = 'on';
                drone.lastError = null;
            } catch (error) {
                drone.powerState = 'failed';
                drone.lastError = error.message;
            } finally {
                UIManager.render(State);
            }
        },

        /** ì§€ë„ ëª¨ë“œ ë³€ê²½ ë¡œì§ */
        setMapMode(modeToToggle) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (drone.powerState !== 'on') return alert("ë“œë¡  ì „ì›ì„ ë¨¼ì € ì¼œì£¼ì„¸ìš”.");
            if (drone.flightState !== 'grounded' && modeToToggle === 'set_home') return alert("ë¹„í–‰ ì¤‘ì—ëŠ” í™ˆì„ ì¬ì§€ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const currentMode = State.ui.activeMapMode;
            const isTurningOn = currentMode !== modeToToggle;
            
            const modeKor = { recon: 'ì •ì°°', emergency: 'ì‘ê¸‰', set_home: 'í™ˆ ì§€ì •' };
            const confirmMsg = isTurningOn ? `'${modeKor[modeToToggle]}' ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?` : `'${modeKor[modeToToggle]}' ëª¨ë“œë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (!confirm(confirmMsg)) return;

            // ë§Œì•½ ìƒˆë¡œìš´ ëª¨ë“œë¥¼ ì¼œëŠ” ê²ƒì´ê³ , ê¸°ì¡´ì— ë‹¤ë¥¸ ëª¨ë“œê°€ ì¼œì ¸ ìˆì—ˆë‹¤ë©´, ìë™ ë¹„í™œì„±í™”
            if (isTurningOn && currentMode !== 'none') {
                alert(`'${modeKor[currentMode]}' ëª¨ë“œê°€ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.`);
                // ê¸°ì¡´ ëª¨ë“œì— ëŒ€í•œ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
                if (currentMode === 'recon') MapManager.clearMissionPath();
                if (currentMode === 'emergency') MapManager.clearEmergencyMarker();
            }

            // ìµœì¢…ì ìœ¼ë¡œ ìƒíƒœë¥¼ ë³€ê²½
            State.ui.activeMapMode = isTurningOn ? modeToToggle : 'none';
            
            // ëª¨ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ëŒ ë•Œ ì¶”ê°€ ì •ë¦¬ ì‘ì—…
            if (!isTurningOn) {
                if (modeToToggle === 'recon') MapManager.clearMissionPath();
                if (modeToToggle === 'emergency') MapManager.clearEmergencyMarker();
            }
            
            UIManager.render(State); // ë³€ê²½ëœ ìƒíƒœì— ë”°ë¼ ì „ì²´ UIë¥¼ ë‹¤ì‹œ ê·¸ë¦¼
        },

        /** ì§€ë„ í´ë¦­ í•¸ë“¤ëŸ¬ */
        handleMapClick(latlng) {
            const { activeMapMode, selectedDroneId } = State.ui;
            if (activeMapMode === 'none') return;

            const drone = State.drones[selectedDroneId];
            
            if (activeMapMode === 'set_home') {
                // 1. ìƒíƒœ ë³€ê²½
                drone.hasHome = true;
                drone.homePosition = latlng;

                // 2. ì „ë¬¸ê°€ì—ê²Œ ì§€ì‹œ
                MapManager.setHomeMarker(latlng);
                alert(`${selectedDroneId}ì˜ í™ˆ ìœ„ì¹˜ê°€ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // 3. ëª¨ë“œ ìë™ ì¢…ë£Œ
                this.setMapMode('set_home'); // í™ˆ ì§€ì • í›„ ëª¨ë“œ ìë™ ì¢…ë£Œ
            } else if (activeMapMode === 'recon') {
                State.missions.currentMissionPoints.push({ lat: latlng.lat, lng: latlng.lng });
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            } else if (activeMapMode === 'emergency') {
                State.missions.emergencyTarget = { lat: latlng.lat, lng: latlng.lng }; // ì‘ê¸‰ ëª©í‘œ ì €ì¥
                MapManager.setEmergencyMarker(latlng);
            }

            // â—ï¸[ë²„ê·¸ ìˆ˜ì •] handleMapClickì˜ ë‹¤ë¥¸ ë¶„ê¸°(recon, emergency)ë¥¼ ìœ„í•´
            // ë§ˆì§€ë§‰ì— UI ë Œë”ë§ì„ í•œë²ˆ ë” í˜¸ì¶œí•´ì£¼ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
            // setMapModeëŠ” ë‚´ë¶€ì ìœ¼ë¡œ renderë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ 'set_home' ì¼€ì´ìŠ¤ëŠ” ê´œì°®ì§€ë§Œ,
            // ë‹¤ë¥¸ ì¼€ì´ìŠ¤ë¥¼ ìœ„í•´ ì¶”ê°€í•©ë‹ˆë‹¤.
            UIManager.render(State);
        },
        
        /** ë¯¸ì…˜ ì‹œì‘ */
        startMission(index) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!this._checkPreFlight(drone)) return;
            const mission = State.missions.savedMissions[index];
            if (!mission) return alert("ë¯¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (confirm(`'${mission.name}' ë¯¸ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                drone.flightState = 'recon_mission';
                UIManager.render(State);
                MapManager.renderMissionPath(mission.points);
                
                // ì‹œì‘ì ì€ ë“œë¡ ì˜ í˜„ì¬ í™ˆ ìœ„ì¹˜ë¡œ ê°€ì •
                const startPoint = drone.homePosition || mission.points[0];
                const flightPath = [startPoint, ...mission.points];
                MapManager.animateDronePath(State.ui.selectedDroneId, flightPath);
            }
        },
        
        completeMission(droneId) {
            const drone = State.drones[droneId];
            alert(`${droneId}ì˜ ë¯¸ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            drone.flightState = 'grounded';
            MapManager.clearMissionPath();
            UIManager.render(State);
        },

        /** ì ê²€ ëª¨ë“œ ì‹¤í–‰ */
        async inspection(mode) {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!this._checkPreFlight(drone)) return;

           const modeText = { arming: 'Arming', hover: 'Hover', drop: 'íˆ¬í•˜ ì ê²€' }[mode];
            if (!confirm(`${modeText} ì ê²€ ëª¨ë“œë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            if (mode === 'hover') {
                    drone.flightState = 'hovering';
                    UIManager.render(State);
                    setTimeout(() => { // í˜¸ë²„ë§ ì ê²€ í›„ ìë™ ì°©ë¥™ ì‹œë®¬ë ˆì´ì…˜
                        drone.flightState = 'grounded';
                        UIManager.render(State);
                        alert("Hover ì ê²€ ì™„ë£Œ ë° ì°©ë¥™.");
                    }, 5000);
                }
                alert(`${modeText} ëª…ë ¹ ì „ì†¡.`);
        },
        
        /** [ì¶”ê°€ë¨] ì‘ê¸‰ ì¶œë™ ë¯¸ì…˜ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ */
        startEmergencyMission() {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!this._checkPreFlight(drone)) return;
            
            const target = State.missions.emergencyTarget;
            if (!target) return alert("ì‘ê¸‰ ëª©í‘œ ì§€ì ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

            if (confirm(`ì‘ê¸‰ ë¯¸ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª©í‘œ: (${target.lat.toFixed(4)}, ${target.lng.toFixed(4)})`)) {
                drone.flightState = 'emergency_mission';
                UIManager.render(State);
                
                // ì‹œì‘ì (í™ˆ)ê³¼ ëª©í‘œ ì§€ì  ì‚¬ì´ì˜ ê²½ë¡œë¥¼ ìƒì„±í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
                const startPoint = drone.homePosition;
                const path = [startPoint, target];
                MapManager.animateDronePath(State.ui.selectedDroneId, path);

                // ApiClient.startEmergencyMission(...)
            }
        },

        /** [ì¶”ê°€ë¨] ë¯¸ì…˜/ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ */
        completeMission(droneId) {
            const drone = State.drones[droneId];
            alert(`${droneId}ì˜ ë¯¸ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            drone.flightState = 'grounded';
            MapManager.clearMissionPath();
            MapManager.clearEmergencyMarker(); // ì‘ê¸‰ ë§ˆì»¤ë„ ì •ë¦¬
            State.missions.emergencyTarget = null; // ì‘ê¸‰ ëª©í‘œ ì´ˆê¸°í™”
            UIManager.render(State);
        },

        inFlightDrop() {
            const drone = State.drones[State.ui.selectedDroneId];
            if (drone.flightState === 'grounded') return alert("ë“œë¡ ì´ ë¹„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.");
            if (confirm("ë¹„í–‰ ì¤‘ ë¬¼í’ˆì„ íˆ¬í•˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                alert("ë¬¼í’ˆ íˆ¬í•˜ ëª…ë ¹ ì „ì†¡!");
                // ApiClient.dropPayload(...)
            }
        },

        /** [ìˆ˜ì •ë¨] ì±…ì„ ë¶„ë¦¬ ì›ì¹™ì— ë”°ë¼, MapManagerì—ê²Œ ì§€ì‹œë§Œ ë‚´ë¦¬ë„ë¡ ë³€ê²½ */
        centerOnUser() {
            if (!navigator.geolocation) {
                return alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const userLocation = { lat: latitude, lng: longitude };
                    
                    // ì§€íœ˜ê´€ì€ ì „ë¬¸ê°€ì—ê²Œ ì§€ì‹œë§Œ ë‚´ë¦°ë‹¤.
                    MapManager.panTo(userLocation);
                    MapManager.showUserMarker(userLocation);
                },
                (error) => {
                    alert(`ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            );
        },

        _checkPreFlight(drone) {
            if (drone.powerState !== 'on') { alert("ë“œë¡  ì „ì›ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤."); return false; }
            if (!drone.hasHome) { alert("í™ˆ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤."); return false; }
            if (drone.status.battery < 20) { alert("ë°°í„°ë¦¬ê°€ ë¶€ì¡±í•˜ì—¬ ì´ë¥™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return false; }
            if (drone.status.gps !== 'GOOD' || drone.status.lte !== 'GOOD') { alert("GPS ë˜ëŠ” LTE ì‹ í˜¸ê°€ ë¶ˆì•ˆì •í•˜ì—¬ ì´ë¥™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return false; }
            return true;
        },

        saveMission() {
            const { currentMissionPoints, savedMissions } = State.missions;
            if (currentMissionPoints.length < 2) return alert("ì •ì°° ì§€ì ì€ 2ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
            const name = prompt("ì €ì¥í•  ë¯¸ì…˜ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", `ë¯¸ì…˜ ${savedMissions.length + 1}`);
            if (!name) return;
            
            savedMissions.push({ name, points: [...currentMissionPoints] });
            State.missions.currentMissionPoints = [];
            MapManager.clearMissionPath();
            UIManager.render(State);
        },
        
        loadMission(index) {
            const mission = State.missions.savedMissions[index];
            if (mission) {
                State.missions.currentMissionPoints = [...mission.points];
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            }
        },
        
        deleteSavedMission(index) {
            if (confirm("ì •ë§ë¡œ ì´ ë¯¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                State.missions.savedMissions.splice(index, 1);
                UIManager.render(State);
            }
        },
        
        deleteMissionPoint(index) {
            State.missions.currentMissionPoints.splice(index, 1);
            // ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ, MapManagerì—ê²Œ ë‹¤ì‹œ ê·¸ë¦¬ë¼ê³  ì§€ì‹œ
            MapManager.renderMissionPath(State.missions.currentMissionPoints);
        },
        
        updateMissionPointPosition(index, newLatLng) {
            if (State.missions.currentMissionPoints[index]) {
                State.missions.currentMissionPoints[index] = { lat: newLatLng.lat, lng: newLatLng.lng };
                // ìœ„ì¹˜ê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ, ê²½ë¡œ(Polyline)ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ë„ë¡ ì§€ì‹œ
                MapManager.renderMissionPath(State.missions.currentMissionPoints);
            }
        },

        emergencyReturn() {
            const drone = State.drones[State.ui.selectedDroneId];
            if (!drone.hasHome) return alert("í™ˆ ìœ„ì¹˜ê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            if (confirm("ë¹„ìƒë³µê·€ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                drone.flightState = 'returning';
                MapManager.startBlinkingHomeMarker(); // í™ˆ ë§ˆì»¤ ê¹œë¹¡ì„ ì‹œì‘
                UIManager.render(State);
                
                const command = {
                    command: 'EMERGENCY_RETURN_TO_HOME',
                    lat: drone.homePosition.lat,
                    lng: drone.homePosition.lng,
                };
                alert(`ë¹„ìƒë³µê·€ ëª…ë ¹ ì „ì†¡!\n${JSON.stringify(command)}`);
                // ApiClient.emergencyReturn(State.ui.selectedDroneId, command);
                
                // (ì‹œë®¬ë ˆì´ì…˜) ë³µê·€ê°€ ëë‚˜ë©´ ìƒíƒœë¥¼ ë³€ê²½í•˜ê³  ë§ˆì»¤ ê¹œë¹¡ì„ì„ ë©ˆì¶¤
                setTimeout(() => {
                    drone.flightState = 'grounded';
                    MapManager.stopBlinkingHomeMarker();
                    UIManager.render(State);
                    alert("ë¹„ìƒë³µê·€ ì™„ë£Œ.");
                }, 5000);
            }
        },
        
        logout() {
            if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                window.location.href = "/logout";
            }
        },
    
        renameMission(index, newName) {
            if (State.missions.savedMissions[index]) {
                State.missions.savedMissions[index].name = newName.trim();
                console.log(`ë¯¸ì…˜ ${index}ì˜ ì´ë¦„ì´ '${newName.trim()}'ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // UIManager.render(State)ë¥¼ í˜¸ì¶œí•  ìˆ˜ë„ ìˆì§€ë§Œ, ì´ë¦„ ë³€ê²½ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë˜ë¯€ë¡œ í•„ìˆ˜ëŠ” ì•„ë‹˜
            }
        }
    };

    // =======================================================================
    // 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
    // =======================================================================
    window.addEventListener('load', () => AppController.init());
    window.addEventListener('beforeunload', () => WebRTCManager.disconnect());

/*

í˜„ì¬ 1~4ê¹Œì§€ ë””ë²„ê¹…ìš©ì´ë‹ˆê¹Œ ì „ë¶€ ê¸°ëŠ¥ì´ë‘ ë¡œì§ë§Œ êµ¬í˜„ í•´ì£¼ë©´ ì¢‹ì„ê±°ê°™ì•„.
1. ì§€ë„ ìœ„ì˜ makerì—ì„œ ì‘ê¸‰ëª¨ë“œ ì¶œë°œ ì´ë¼ëŠ” ë²„íŠ¼ì´ ì—†ìŒ. "ğŸš¨ ì‘ê¸‰ ìœ„ì¹˜" ì•„ë˜ì— ë§Œë“¤ ê²ƒ. ì‹œì‘ ë²„íŠ¼ ë§Œë“¤ê²ƒ.
2. ì •ì°°ëª¨ë“œ ë˜ëŠ” ì‘ê¸‰ëª¨ë“œì‹œì— ì§€ë„ ìœ„ì— ì´ë™ê²½ë¡œë¥¼ í‘œì‹œí• ê²ƒ.
    => ì •ì°°ëª¨ë“œ ì¼ë•Œ ê³µìš© ë¯¸ì…˜ ëª©ë¡ì˜ ì‹œì‘ë²„íŠ¼ => ì´ë™ê²½ë¡œ í‘œì‹œí• ê²ƒ.
    => ì‘ê¸‰ëª¨ë“œ ì¼ë•Œ ìœ„ì˜ 1ì˜ ë²„íŠ¼ í´ë¦­ì‹œ => ì´ë™ê²½ë¡œ í‘œì‹œí• ê²ƒ.
ì´ë™ê²½ë¡œ í‘œì‹œí›„ ì˜ˆë¥¼ ë“¤ì–´ì„œ ë“œë¡ 1ì´ ì •ì°°ëª¨ë“œë¥¼ ìˆ˜í–‰ì¤‘ì´ë¼ë©´ ì§€ë„ìœ„ì—ìˆëŠ” ê²½ë¡œì— ë“œë¡ 1ì´ ê·¸ ê²½ë¡œ ìœ„ë¥¼ ìì‹ ì˜ gpsê°’ì„ ë°›ì•„ ì›¹ì‚¬ì´íŠ¸ë¡œ ë°›ì•„ì„œ í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ í•´ì¤˜.

2.1 í˜¹ì‹œ ëª°ë¼ì„œ ê·¸ëŸ¬ëŠ”ë° ë“œë¡ ì´ ì •ì°°ëª¨ë“œ, ì‘ê¸‰ëª¨ë“œë¥¼ ìˆ˜í–‰ì´ ëë‚˜ë©´ drone1~5ì—ì„œ ë™ì‘ì´ ëë‚¬ë‹¤ë©´ groundë¼ê³  ì œì–´ì‹ í˜¸ë¥¼ ë³´ë‚´ì„œ ìƒíƒœë¥¼ ë°”ê¾¸ê²Œí•˜ëŠ” ë¡œì§ì´ ìˆì–´ì•¼ë ê±° ê°™ì•„.


3. ì§€ë„ì—ì„œ ì‚¬ìš©ìì˜ í˜„ì¬ìœ„ì¹˜ markerë¥¼ ë”ì¶”ê°€í•´ì„œ í‘œì‹œí•  ìˆ˜ ìˆë‹¤ë©´ í‘œì‹œí• ê²ƒ.
    => ì§€ë„ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ì‚¬ìš©ì í˜„ì¬ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì´ë™í•˜ë„ë¡  ë²„íŠ¼ ë°°ì¹˜

4. íŠœë¸Œ íˆ¬í•˜ ê¸°ëŠ¥ ì¶”ê°€ 
    => ì ê²€ëª¨ë“œì— ë²„íŠ¼ ì¶”ê°€
        => groundì— ìˆì„ë•Œë§Œ ì‚¬ìš©ê°€ëŠ¥
    => ë¹„í–‰ì¤‘ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë¹„í–‰ì¤‘ ë¬¼í’ˆíˆ¬í•˜ ë²„íŠ¼ ì¶”ê°€
        => ë¹„í–‰ì¤‘ ì¼ë•Œë§Œ ê°€ëŠ¥
*/
</script>
</body>
</html>



